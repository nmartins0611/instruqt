## Controller setup
- name: Controller config for Terraform-Ansible
  hosts: controller.acme.example.com
  gather_facts: true
    
  tasks:
   # Create auth login token
    - name: get auth token and restart automation-controller if it fails
      block:
        - name: Refresh facts
          setup:

        - name: Create oauth token
          awx.awx.token:
            description: 'Instruqt lab'
            scope: "write"
            state: present
            controller_host: controller
            controller_username: "{{ controller_admin_user }}"
            controller_password: "{{ controller_admin_password }}"
            validate_certs: false
          register: _auth_token
          until: _auth_token is not failed
          delay: 3
          retries: 5
      rescue:
        - name: In rescue block for auth token
          debug:
            msg: "failed to get auth token. Restarting automation controller service"

        - name: restart the controller service
          ansible.builtin.service:
            name: automation-controller
            state: restarted

        - name: Ensure tower/controller is online and working
          uri:
            url: https://localhost/api/v2/ping/
            method: GET
            user: "{{ admin_username }}"
            password: "{{ admin_password }}"
            validate_certs: false
            force_basic_auth: true
          register: controller_online
          until: controller_online is success
          delay: 3
          retries: 5

        - name: Retry getting auth token
          awx.awx.token:
            description: 'Instruqt lab'
            scope: "write"
            state: present
            controller_host: controller
            controller_username: "{{ controller_admin_user }}"
            controller_password: "{{ controller_admin_password }}"
            validate_certs: false
          register: _auth_token
          until: _auth_token is not failed
          delay: 3
          retries: 5
      always:
        - name: Create fact.d dir
          ansible.builtin.file:
            path: "{{ custom_facts_dir }}"
            state: directory
            recurse: yes
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: 0755
          become: true

        - name: Create _auth_token custom fact
          ansible.builtin.copy:
            content: "{{ _auth_token.ansible_facts }}"
            dest: "{{ custom_facts_dir }}/{{ custom_facts_file }}"
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: 0644
          become: true
      check_mode: false
      when: ansible_local.custom_facts.controller_token is undefined
      tags:
        - auth-token

    - name: refresh facts
      setup:
        filter:
          - ansible_local
      tags:
        - always

    - name: create auth token fact
      ansible.builtin.set_fact:
        auth_token: "{{ ansible_local.custom_facts.controller_token }}"
        cacheable: true
      check_mode: false
      when: auth_token is undefined
      tags:
        - always
 
    - name: Ensure tower/controller is online and working
      uri:
        url: https://localhost/api/v2/ping/
        method: GET
        user: "{{ admin_username }}"
        password: "{{ admin_password }}"
        validate_certs: false
        force_basic_auth: true
      register: controller_online
      until: controller_online is success
      delay: 3
      retries: 5
      tags:
        - controller-config

# Controller objects
    - name: Add Organization
      awx.awx.organization:
        name: "{{ lab_organization }}"
        description: "ACME Corp Organization"
        state: present
        controller_oauthtoken: "{{ auth_token }}"
        validate_certs: false
      tags:
        - controller-config
        - controller-org
  
    - name: Add Instruqt Terraform EE
      awx.awx.execution_environment:
        name: "{{ controller_devops_ee }}"
        image: "quay.io/acme_corp/terraform_ee"
        pull: missing
        state: present
        controller_oauthtoken: "{{ auth_token }}"
        controller_host: "{{ controller_hostname }}"
        validate_certs: "{{ controller_validate_certs }}"
      tags:
        - controller-config
        - controller-ees

    - name: Pull Instruqt Terraform EE
      containers.podman.podman_image:
        name: "quay.io/acme_corp/terraform_ee"
      become_user: awx
      register: podman_pull
      until: podman_pull is not failed
      retries: 5
      delay: 15 
      tags:
        - controller-config
        - controller-ees

#     - name: Add lab inventories
#       awx.awx.inventory:
#         name: "{{ item.name }}"
#         description: "{{ item.description }}"
#         organization: "{{ lab_organization }}"
#         state: present
#         controller_oauthtoken: "{{ auth_token }}"
#         validate_certs: false
#       loop: "{{ lab_inventories }}"
#       tags:
#         - controller-config
#         - controller-objects

#     - name: Create hosts
#       awx.awx.host:
#         name: "{{ item.lab_host_name }}"
#         inventory: "{{ item.lab_host_inventory }}"
#         state: present
#         controller_oauthtoken: "{{ auth_token }}"
#         validate_certs: false
#         variables:  "{{ item.lab_host_vars }}"
#       loop: "{{ lab_hosts }}"
#       tags:
#         - controller-config
#         - controller-hosts
    
#     - name: Create groups
#       awx.awx.group:
#         name: "{{ item.group_name }}"
#         description: "{{ item.group_desc }}"
#         state: present
#         inventory: "{{ item.group_inventory }}"
#         hosts: "{{ item.group_hosts }}"
#         controller_oauthtoken: "{{ auth_token }}"
#         controller_host: "{{ controller_hostname }}"
#         validate_certs: "{{ controller_validate_certs }}"
#       loop: "{{ lab_groups }}"
#       tags:
#         - controller-config
#         - controller-groups

    - name: Add the lab ssh credential
      awx.awx.credential:
        name: "{{ lab_credential_name }}"
        organization: "{{ lab_organization }}"
        credential_type: Machine
        inputs:
          ssh_key_data: "{{ lookup('file', '/home/rhel/.ssh/id_rsa') }}"
        controller_oauthtoken: "{{ auth_token }}"
        validate_certs: false
      tags:
        - controller-config
        - controller-objects

    - name: Add aws credentials
      awx.awx.credential:
        name: "AWS"
        organization: "{{ lab_organization }}"
        credential_type: "Amazon Web Services"
        inputs:
          username: "{{ lookup('ansible.builtin.env', 'AWS_ACCESS_KEY_ID') }}"
          password: "{{ lookup('ansible.builtin.env', 'AWS_SECRET_ACCESS_KEY') }}"
        controller_oauthtoken: "{{ auth_token }}"
        validate_certs: false

    - name: Add the lab project
      awx.awx.project:
        name: "{{ lab_project_name }}"
        scm_type: git
        scm_url: "http://gitea:3000/{{ student_user }}/terraform_lab.git"
        organization: "{{ lab_organization }}"
        scm_update_on_launch: false
        scm_update_cache_timeout: 60
        scm_branch: "main"
        controller_oauthtoken: "{{ auth_token }}"
        validate_certs: false
      tags:
        - controller-config
        - controller-project

    - name: Create job templates
      awx.awx.job_template:
        name: "Deploy Instance with Terraform"
        state: present
        execution_environment: "terraform_ee"
  #      become_enabled: "{{ item.jt_become }}"
        project: "{{ lab_project_name }}"
        credential: "{{ lab_credential_name }}"
        inventory: "{{  item.jt_inventory }}"
        playbook: "{{ item.jt_playbook }}"
 #       survey_enabled: "{{ item.survey_enabled | default( omit ) }}"
 #       survey_spec: "{{ item.survey_spec | default(omit) }}"
 #       ask_inventory_on_launch: "{{  item.jt_prompt_inventory }}"
 #       ask_variables_on_launch: "{{  item.jt_prompt_inventory | default( omit )}}"
 #       extra_vars: "{{ item.jt_extra_vars | default( omit ) }}"
        controller_oauthtoken: "{{ auth_token }}"
        validate_certs: false
 #     loop: "{{ lab_job_templates }}"
  #    tags:
  #      - controller-config
  #      - controller-jts

#     - name: Create Workflows
#       awx.awx.tower_workflow_job_template:
#         name: "{{ item.workflow_name }}"
#         inventory: "{{ item.workflow_inventory }}"
#         extra_vars: "{{ item.workflow_vars | default( omit ) }}"
#         ask_variables_on_launch: "{{ item.workflow_prompt_vars | default( true ) }}"
#         organization:  "{{ item.workflow_org }}"
#         schema: "{{ item.workflow_schema | default( omit )}}"
#         controller_oauthtoken: "{{ auth_token }}"
#         controller_host: "{{ controller_hostname }}"
#         validate_certs: "{{ controller_validate_certs }}"
#       loop: "{{ lab_devops_worklow }}"
#       tags:
#         - controller-config
#         - controller-workflows

#     - name: Create student admin user
#       awx.awx.user:
#         superuser: true
#         username: "{{ student_user }}"
#         password: "{{ student_password }}"
#         email: student@acme.example.com
#         controller_oauthtoken: "{{ auth_token }}"
#         controller_host: "{{ controller_hostname }}"
#         validate_certs: "{{ controller_validate_certs }}"
#       tags:
#         - controller-config
#         - controller-users

